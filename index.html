<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Kode+Mono:wght@400..700&display=swap">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Emoji:wght@300..700&display=swap">
<link rel="stylesheet" href="./style/base.css">
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<style type="text/tailwindcss">
    button {
        @apply border-1 border-gray-900 cursor-pointer px-4 py-2 rounded-lg;
    }
    button:disabled {
        @apply cursor-default opacity-50;
    }
    button:hover {
        @apply bg-white border-white text-gray-700
    }
    input {
        @apply bg-gray-700 border-1 border-gray-900 px-2 py-1 rounded-lg;
    }
    input:disabled {
        @apply bg-cyan-800;
    }
    select {
        @apply appearance-none border-1 border-gray-900 cursor-pointer pl-4 py-1 rounded-lg;
    }
    select:hover {
        @apply bg-white border-white text-gray-700
    }
</style>
<title>MOSH v1.01</title>
</head>
<body class="bg-cathode flex flex-col gap-4 h-screen">

<header class="flex justify-between">
    <div>
        <span class="cyan" id="clock">--/--/---- --:--</span>
    </div>
    <div>
        <span class="ruby" id="countdown-state">‚èπ STOPPED</span>
        <!-- <span id="turn">000</span> -->
    </div>
</header>

<!-- <nav></nav> -->

<main class="cyan flex flex-col gap-4 h-full min-h-1/2 overflow-auto">

    <section class="flex flex-wrap gap-4 justify-center w-full">
        <div class="bg-cyan-600/25 h-60 rounded-xl w-48">
            <div class="flex flex-col text-center">
                <h3 class="border-b border-gray-900 py-2 text-xl">ENVIRONMENT</h3>

                <div class="border-3 border-cyan-200 border-dotted mx-8 my-1 rounded-full size-32">
                    <div class="flex h-full items-center justify-center">
                        <div class="text-7xl" id="environment-scale">
                            <i id="atmosphere-icon">üòë</i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex gap-4 justify-evenly m-2 py-1 text-2xl">
                <i id="gravity-icon">‚öì</i>
                <i class="opacity-50" id="radiation-icon">‚ò¢</i>
                <i id="light-icon">üîÖ</i>
            </div>
        </div>

        <div class="hidden bg-amber-600/25 h-60 rounded-xl w-48" id="encounter-panel">
            <div class="flex flex-col text-center">
                <h3 class="border-b border-gray-900 py-2 text-xl">ENCOUNTER</h3>

                <div class="flex h-32 items-center justify-center">
                    <i class="amber text-8xl">‚úã</i>
                </div>
            </div>
            <div class="flex gap-4 justify-center pt-1 text-2xl">
                <button class="w-16" id="encounter-dismiss">
                    <i class="ruby">‚ùå</i>
                </button>
                <button class="w-16" id="encounter-resolve">
                    <i class="green">‚úîÔ∏é</i>
                </button>
            </div>
        </div>

        <div class="bg-cyan-600/25 h-60 rounded-xl w-48" id="zone-panel">
            <div class="flex flex-col text-center">
                <h3 class="border-b border-gray-900 py-2 text-xl">ZONE</h3>

                <div class="flex h-32 items-center justify-center">
                    <span class="text-7xl" id="zone-label">-?-</span>
                </div>
            </div>
            <div class="flex gap-4 justify-center pt-1 text-2xl">
                <button class="w-16" disabled id="encounter-show">
                    <i class="cyan">‚úã</i>
                </button>
                <button class="w-16" id="zone-modal-show">
                    <i class="cyan">‚Æï</i>
                </button>
            </div>
        </div>

        <div class="bg-cyan-600/25 h-60 rounded-xl w-100">
            <div class="text-center">
                <div class="border-b border-gray-900 px-4 py-2 text-xl">
                    <h3 id="countdown-header">-?-</h3>
                </div>

                <div class="flex flex-col h-32 justify-center text-9xl">
                    <span id="countdown-clock">--:--</span>
                </div>
            </div>
            <div class="flex gap-4 justify-center pt-1 text-2xl">
                <select class="cyan text-sm w-16" id="countdown-speed">
                    <option value="5.0">5.0&times;</option>
                    <option value="2.0">2.0&times;</option>
                    <option selected value="1.0">1.0&times;</option>
                    <option value="0.5">0.5&times;</option>
                    <option value="0.2">0.2&times;</option>
                </select>

                <button class="cyan w-16" disabled id="countdown-pause">‚ñ∂</button>

                <button class="cyan w-16" disabled id="countdown-skip">‚è≠Ô∏é</button>

                <button class="w-16" id="countdown-mute">
                    <i class="ruby">üîï</i>
                </button>
            </div>
        </div>
    </section>

    <section class="hidden flex flex-wrap gap-4 justify-center w-full">
        <div class="bg-cyan-600/25 h-60 rounded-xl w-48">
            <div class="flex flex-col">
                <h3 class="border-b border-gray-900 py-2 text-center">LCP MINERVA</h3>

                <div class="flex">
                    <div class="overflow-hidden relative size-32">
                        <img class="opacity-60" src="./img/4D9N-5LOOQZ.png">
                    </div>

                    <ul class="flex flex-col gap-2 justify-between pr-2 pt-2 text-right w-16 whitespace-nowrap">
                        <li>36¬∞C</li>
                        <li>70 ‚ô•</li>
                        <li>.99O‚ÇÇ</li>
                        <li>118mm</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="amber bg-amber-600/25 h-60 rounded-xl w-48">
            <div class="flex flex-col">
                <h3 class="border-b border-gray-900 py-2 text-center">DR ZAHIR</h3>

                <div class="flex">
                    <div class="overflow-hidden relative size-32">
                        <img class="opacity-60" src="./img/CW01-241127.png">
                    </div>

                    <ul class="flex flex-col gap-2 justify-between pr-2 pt-2 text-right w-16 whitespace-nowrap">
                        <li>37¬∞C</li>
                        <li class="pulse ruby">147 ‚ô•</li>
                        <li>.97O‚ÇÇ</li>
                        <li>135mm</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="ruby bg-red-600/25 h-60 rounded-xl w-48">
            <div class="flex flex-col">
                <h3 class="border-b border-gray-900 py-2 text-center">PVT LOUIS</h3>

                <div class="flex">
                    <div class="overflow-hidden relative size-32">
                        <img class="opacity-60" src="./img/HR01-241127.png">
                        <div class="absolute bg-red-900 block h-46 left-15 rotate-45 -top-7 w-2"></div>
                        <div class="absolute bg-red-900 block h-46 left-15 -rotate-45 -top-7 w-2"></div>
                    </div>

                    <ul class="flex flex-col gap-2 justify-between pr-2 pt-2 text-right w-16 whitespace-nowrap">
                        <li>---¬∞C</li>
                        <li>--- ‚ô•</li>
                        <li>---O‚ÇÇ</li>
                        <li>---mm</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="pulse-2s bg-cyan-600/25 h-60 rounded-xl w-48">
            <div class="flex flex-col">
                <h3 class="border-b border-gray-900 py-2 text-center">√âGLE-2</h3>

                <div class="flex">
                    <div class="overflow-hidden relative size-32">
                        <img class="opacity-60" src="./img/LF01-241127.png">
                    </div>

                    <ul class="flex flex-col gap-2 justify-between pl-2 pt-2 text-left w-16 whitespace-nowrap">
                        <li class="amber">‚ñà‚ñà‚ñà‚ñç</li>
                        <li>‚ñà‚ñà‚ñç</li>
                        <li class="ruby">‚ñà‚ñà‚ñà‚ñà‚ñà</li>
                        <li>‚ñè</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

</main>

<section class="grow min-h-1/6 overflow-y-scroll">
    <div class="flex flex-col-reverse gap-1 whitespace-nowrap" id="session-output"></div>
</section>

<footer>
    <input class="w-full" id="session-input" placeholder=">_">
</footer>

<div class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-700/50" id="zone-modal">
    <div class="bg-cyan-900 rounded-lg shadow-xl max-w-md w-full mx-auto overflow-hidden">
        <div class="flex gap-2 items-center p-4 border-b border-cyan-200">
            <label class="text-lg font-semibold" for="zone-input">ZONE:</label>

            <div class="relative">
                <input class="w-20" id="zone-input" list="zone-exits" maxlength="4" required>
                <datalist class="left-0 z-999" id="zone-exits"></datalist>
            </div>

            <input class="w-full" id="zone-description">
        </div>

        <div class="flex flex-col gap-4 p-6">
            <div class="flex items-center">
                <label class="mr-2" for="zone-light">AIR:</label>

                <select class="p-4 text-center w-full" id="zone-atmosphere">
                    <option value="breathable">Breathable</option>
                    <option value="corrosive">Corrosive</option>
                    <option value="extreme_cold">Extreme cold</option>
                    <option value="extreme_heat">Extreme heat</option>
                    <option value="hypoxic">Hypoxic</option>
                    <option value="toxic">Toxic</option>
                    <option value="vacuum">Vacuum</option>
                </select>

                <label class="ml-4 mr-2" for="zone-light">LIGHT:</label>
                <select class="p-4 text-center w-1/2" id="zone-light">
                    <option value="bright">Bright</option>
                    <option value="dark">Dark</option>
                    <option value="dim">Dim</option>
                </select>
            </div>
            <div class="flex items-center">
                <label class="mr-2" for="zone-gravity">GRAVITY:</label>
                <select class="p-4 text-center" id="zone-gravity">
                    <option value="standard">Standard</option>
                    <option value="zero_g">Zero-G</option>
                </select>

                <label class="ml-4 mr-2" for="zone-radiation">RADIATION:</label>
                <select class="p-4 text-center w-1/2" id="zone-radiation">
                    <option value="trace">Trace</option>
                    <option value="acute">Acute</option>
                    <option value="lethal">Lethal</option>
                </select>
            </div>
            <div class="flex items-center">
                <label class="mr-2" for="zone-scale">SCALE:</label>
                <select class="p-4 text-center" id="zone-scale">
                    <option value="normal">Normal</option>
                    <option value="industrial">Industrial</option>
                </select>

                <label class="ml-4 mr-2" for="zone-exit-via">VIA:</label>
                <input class="w-full" disabled id="zone-exit-via">
            </div>
            <div class="flex items-center">
                <label class="mr-2" for="zone-encounter-rate">%ENC:</label>
                <input class="w-full" id="zone-encounter-rate" max="1.0" min="0.0" step="0.05" type="range" value="0.1">
            </div>
        </div>

        <div class="flex justify-end items-center p-4 border-t border-cyan-200 space-x-2">
            <button id="zone-modal-cancel">CANCEL</button>
            <button id="zone-modal-confirm">CONFIRM</button>
        </div>
    </div>
</div>

<script>
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    const atmosphereIcon = document.getElementById('atmosphere-icon');
    const countdownClock = document.getElementById('countdown-clock');
    const countdownHeader = document.getElementById('countdown-header');
    const countdownMute = document.getElementById('countdown-mute');
    const countdownPause = document.getElementById('countdown-pause');
    const countdownSkip = document.getElementById('countdown-skip');
    const countdownSpeed = document.getElementById('countdown-speed');
    const countdownState = document.getElementById('countdown-state');
    const encounterPanel = document.getElementById('encounter-panel');
    const encounterShow = document.getElementById('encounter-show');
    const environmentScale = document.getElementById('environment-scale');
    const gravityIcon = document.getElementById('gravity-icon');
    const lightIcon = document.getElementById('light-icon');
    const radiationIcon = document.getElementById('radiation-icon');
    const sessionInput = document.getElementById('session-input');
    const sessionOutput = document.getElementById('session-output');
    const zoneAtmosphere = document.getElementById('zone-atmosphere');
    const zoneDescription = document.getElementById('zone-description');
    const zoneEncounterRate = document.getElementById('zone-encounter-rate');
    const zoneExits = document.getElementById('zone-exits');
    const zoneExitVia = document.getElementById('zone-exit-via');
    const zoneGravity = document.getElementById('zone-gravity');
    const zoneInput = document.getElementById('zone-input');
    const zoneLabel = document.getElementById('zone-label');
    const zoneLight = document.getElementById('zone-light');
    const zoneModal = document.getElementById('zone-modal');
    const zonePanel = document.getElementById('zone-panel');
    const zoneRadiation = document.getElementById('zone-radiation');
    const zoneScale = document.getElementById('zone-scale');

    const clockEpochOffset = 12_622_780_800_000; // 400 years (skip 3 leap days)
    const clockInterval = 600_000; // 10 minutes
    const countdownInterval = 1000; // milliseconds
    const countdownResetValue = 600_000; // 10 minutes
    const countdownWarningCritical = 10_000; // 10 seconds
    const countdownWarningThreshold = 60_000; // 60 seconds

    const commands = {
        clear: function () {
            window.localStorage.clear();
            displaySessionOutput('Local storage cleared.', 'blink ruby');
        },

        dump: function () {
            let dump = {current: current, journal: journal, zones: zones};
            console.log(JSON.stringify(dump));
        },

        // TODO move, air, gravity, light, radiation
        // TODO describe room, exits, amend journal entry
    };

    const icons = {
        atmosphere: {
            breathable: ['üòê'], // üôÇ
            corrosive: ['‚ö†Ô∏é', 'amber'], // ü´†
            extreme_cold: ['ü•∂', 'sapphire'],
            extreme_heat: ['ü•µ', 'amber'],
            hypoxic: ['üò´', 'amber'], // üò©
            toxic: ['‚ò†', 'amber'], // ü§Æ
            vacuum: ['üòµ', 'ruby'], // üò±
        },

        gravity: {
            standard: ['‚öì'], // ü™®
            zero_g: ['ü™∂', 'amber'],
        },

        light: {
            bright: ['üîÜ'], // üåûüåë‚ö™‚óè
            dark: ['üåï', 'ruby pulse-2s'], // üî¶üëÄüëÅ‚ö´‚óã
            dim: ['üåô', 'amber'], // üåñ
        },
        
        radiation: {
            trace: ['‚ò¢', 'opacity-50'], // üü°‚ö™‚óè‚ãØ
            acute: ['‚ò¢', 'amber pulse-2s'], // ‚ú≥Ô∏é
            lethal: ['‚ò¢', 'ruby pulse'], // üî•‚ÄºÔ∏éüíÄ‚ò†
        },
    };

    let countdownSound = false;
    let countdownTimer = null;
    let countdownValue = countdownResetValue;
    let current = null;
    let journal = null;
    let zones = null;
    
    // TODO combat rounds
    // TODO depth gauge
    // TODO fatigue/exhaustion
    // TODO fast travel
    // TODO industrial scale: three turns to traverse?
    // TODO node graph: sigmajs.org
    // TODO encounter tables
    // TODO sites/levels
    // TODO Google Sheets connection?

    function advanceClock() {
        let comment = sessionInput.value.trim();

        if (comment.startsWith('/')) {
            comment = null;
        } else {
            sessionInput.value = '';
        }

        if (! comment && (current.encounter ?? false)) {
            comment = (current.encounter.roll ?? 'ENC').toLocaleString().padStart(2, '0');
        }
        
        if (comment) {
            displayJournalEntry(recordJournalEntry(comment));
        }

        current.encounter = null;
        current.time += clockInterval;
        current.turn++;
        window.localStorage.setItem('mosh:current', JSON.stringify(current));
        updateClock();

        countdownValue = countdownResetValue;
        updateCountdown();
    }

    function displayJournalEntry(entry) {
        displaySessionOutput([
            formatDate(entry.time),
            formatTime(entry.time),
            (entry.zone ?? '---').padStart(3, '0'),
            entry.comment,
        ].join(' '), (entry.encounter ?? false) ? 'amber' : null);
    }

    function displaySessionOutput(text, style = null) {
        const entry = document.createElement('p');

        entry.innerText = text;

        if (style) {
            entry.setAttribute('class', style);
        }

        sessionOutput.appendChild(entry);
    }

    function enableCountdownButtons() {
        countdownPause.removeAttribute('disabled');
        countdownSkip.removeAttribute('disabled');
        encounterShow.removeAttribute('disabled');
    }

    function expireCountdown() {
        suspendCountdown();

        if (Math.random() < current.encounterRate) {
            current.encounter = {roll: Math.floor(Math.random() * 10)};
            sessionInput.value = current.encounter.roll.toLocaleString().padStart(2, '0');
            playTone(660, 1.0, 'sine');
            updateEncounter();
        } else {
            advanceClock();
            resumeCountdown();
        }
    }

    function formatDate(value) {
        return new Intl.DateTimeFormat(undefined, {
            dateStyle: 'short',
            timeZone: 'UTC'
        }).format(value);
    }

    function formatTime(value) {
        return new Intl.DateTimeFormat(undefined, {
            timeStyle: 'short',
            timeZone: 'UTC'
        }).format(value);
    }

    function playTone(frequency, duration = 1.0, waveform = 'sine') {
        if (audioContext?.state !== 'running') {
            return;
        }

        const gainNode = audioContext.createGain();

        gainNode.gain.value = 0.10; // 10%
        gainNode.connect(audioContext.destination);

        const oscillator = audioContext.createOscillator();

        oscillator.frequency.value = frequency; // Hz
        oscillator.type = waveform;
        oscillator.connect(gainNode);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + duration); // seconds
    }

    function recordJournalEntry(comment) {
        let entry = {
            comment: comment,
            encounter: current.encounter ?? null,
            time: current.time,
            zone: current.zone,
        }

        journal.push(entry);

        window.localStorage.setItem('mosh:journal', JSON.stringify(journal));

        return entry;
    }

    function resumeCountdown() {
        if (countdownTimer) {
            return;
        }

        countdownPause.innerHTML = '‚è∏';
        countdownState.innerText = '‚èµ RUNNING';
        countdownState.setAttribute('class', 'green');
        updateCountdown();

        countdownTimer = window.setInterval(function () {
            countdownValue -= countdownInterval * countdownSpeed.value;

            if (countdownValue <= 0) {
                countdownValue = 0;
                expireCountdown();
            }

            updateCountdown();
        }, countdownInterval);
    }

    function suspendCountdown() {
        if (! countdownTimer) {
            return;
        }

        countdownPause.innerHTML = '‚èµ';
        countdownState.innerText = '‚è∏ PAUSED';
        countdownState.setAttribute('class', 'amber blink-1s');
        window.clearInterval(countdownTimer);
        countdownTimer = null;
    }

    function updateClock() {
        document.getElementById('clock').innerText = [
            formatDate(current.time),
            formatTime(current.time),
        ].join(' ');

        // document.getElementById('turn').innerText = current.turn.toLocaleString().padStart(3, '0');
    }

    function updateCountdown() {
        if (countdownValue <= 0) {
            countdownClock.setAttribute('class', 'ruby');
            playTone(55, 1.0, 'square');
        } else if (countdownValue <= countdownWarningCritical) {
            countdownClock.setAttribute('class', 'amber blink');
            playTone(220, 0.10, 'sawtooth');
        } else if (countdownValue <= countdownWarningThreshold) {
            countdownClock.setAttribute('class', 'amber');
            playTone(440, 0.05, 'triangle');
        } else {
            countdownClock.removeAttribute('class');
        }

        let minutes = Math.floor(countdownValue / 60_000);
        let seconds = Math.floor((countdownValue % 60_000) / 1000);

        countdownClock.innerText = [
            minutes.toLocaleString().padStart(2, '0'),
            seconds.toLocaleString().padStart(2, '0'),
        ].join(':');
    }

    function updateElement(element, text, style = null) {
        element.innerText = text;

        if (style) {
            element.setAttribute('class', style);
        } else {
            element.removeAttribute('class');
        }
    }

    function updateEncounter() {
        countdownPause.setAttribute('disabled', 'disabled');
        countdownSkip.setAttribute('disabled', 'disabled');
        encounterPanel.classList.remove('hidden');
        zonePanel.classList.add('hidden');
    }

    function updateEnvironment(environment) {
        countdownHeader.innerText = environment.description || ('ZONE ' + current.zone);
        zoneLabel.innerText = current.zone;

        if ((environment.scale ?? false) === 'industrial') {
            environmentScale.classList.remove('text-7xl');
            environmentScale.classList.add('text-3xl');
        } else {
            environmentScale.classList.remove('text-3xl');
            environmentScale.classList.add('text-7xl');
        }
        
        updateElement(atmosphereIcon, ...icons.atmosphere[environment.atmosphere]);
        updateElement(radiationIcon, ...icons.radiation[environment.radiation]);
        updateElement(gravityIcon, ...icons.gravity[environment.gravity]);
        updateElement(lightIcon, ...icons.light[environment.light]);
    }

    function updateZoneModal(environment, exits = true) {
        if (exits) {
            zoneExits.innerHTML = '';

            Object.keys(environment.exits ?? {}).forEach(function (exit) {
                let option = document.createElement('option');

                option.setAttribute('value', exit);

                zoneExits.appendChild(option);
            });
        }

        zoneDescription.value = environment.description ?? '';

        zoneAtmosphere.value = environment.atmosphere ?? 'breathable';
        zoneGravity.value = environment.gravity ?? 'standard';
        zoneLight.value = environment.light ?? 'bright';
        zoneRadiation.value = environment.radiation ?? 'trace';
        zoneScale.value = environment.scale ?? 'normal';

        zoneEncounterRate.value = current.encounterRate ?? 0.1;
    }

    countdownPause.addEventListener('click', function () {
        if (countdownTimer) {
            suspendCountdown();
        } else {
            resumeCountdown();
        }
    });

    countdownSkip.addEventListener('click', expireCountdown);

    countdownMute.addEventListener('click', function () {
        if (countdownSound) {
            audioContext.suspend();
            countdownMute.innerHTML = '<i class="ruby">üîï</i>';
            countdownSound = false;
        } else {
            audioContext.resume();
            countdownMute.innerHTML = '<i class="cyan">üîî</i>';
            countdownSound = true;
        }
    });

    encounterShow.addEventListener('click', function () {
        current.encounter = {};
        sessionInput.value = 'Encounter';
        suspendCountdown();
        updateEncounter();
    });

    document.getElementById('encounter-dismiss').addEventListener('click', function () {
        current.encounter = null;
        sessionInput.value = '';
        encounterPanel.classList.add('hidden');
        zonePanel.classList.remove('hidden');
        enableCountdownButtons();
        resumeCountdown();
    });

    document.getElementById('encounter-resolve').addEventListener('click', function () {
        encounterPanel.classList.add('hidden');
        zonePanel.classList.remove('hidden');
        enableCountdownButtons();
        advanceClock();
        resumeCountdown();
    });

    sessionInput,addEventListener('keyup', function (e) {
        if (e.which === 13) { // ENTER
            let comment = sessionInput.value.trim();

            if (! comment) {
                return;
            }
            
            if (comment.startsWith('/')) {
                let arguments = comment.substr(1).split(' ');
                let command = arguments.shift().toLocaleLowerCase();

                if (command in commands) {
                    commands[command](... arguments);
                }
            } else if (current.encounter) {
                advanceClock();
            } else {
                displayJournalEntry(recordJournalEntry(comment));
            }

            sessionInput.value = '';
        } else if (e.which === 27) { // ESC
            sessionInput.value = '';
        }
    });

    zoneInput.addEventListener('blur', function () {
        const zone = zoneInput.value.trim().toUpperCase();

        if (zone in zones) {
            updateZoneModal(zones[zone], false);
        } else if (zone) {
            zoneDescription.value = '';
        }

        if (current.zone ?? false) {
            if (current.zone === zone) {
                zoneExitVia.setAttribute('disabled', 'disabled');
                zoneExitVia.value = '';
            } else {
                zoneExitVia.removeAttribute('disabled');

                let environment = zones[current.zone];

                if (environment.exits ?? false) {
                    zoneExitVia.value = environment.exits[zone].via ?? '';
                }
            }
        }
    });

    document.getElementById('zone-modal-cancel').addEventListener('click', function () {
        zoneModal.classList.add('hidden');
    });

    document.getElementById('zone-modal-confirm').addEventListener('click', function () {
        const zone = zoneInput.value.trim().toUpperCase();

        if (! zone) {
            zoneInput.focus();
            return;
        }

        const via = zoneExitVia.value.trim();

        if (! (current.zone ?? false)) {
            enableCountdownButtons();
        } else if (current.zone !== zone) {
            if (via) {
                let environment = zones[current.zone];
                environment.exits = environment.exits ?? {};
                environment.exits[zone] = {via: via};
            }

            advanceClock();
        }
        
        let environment = zones[zone] ?? {};

        environment.description = zoneDescription.value;
        environment.atmosphere = zoneAtmosphere.value;
        environment.gravity = zoneGravity.value;
        environment.light = zoneLight.value;
        environment.radiation = zoneRadiation.value;
        environment.scale = zoneScale.value;
        environment.exits = environment.exits ?? {};

        if (via) {
            environment.exits[current.zone] = {via: via};
        }

        zones[zone] = environment;

        current.encounterRate = zoneEncounterRate.value;
        current.zone = zone;

        window.localStorage.setItem('mosh:current', JSON.stringify(current));
        window.localStorage.setItem('mosh:zones', JSON.stringify(zones));
        zoneModal.classList.add('hidden');
        sessionInput.focus();

        updateEnvironment(environment);
        resumeCountdown();
    });

    document.getElementById('zone-modal-show').addEventListener('click', function () {
        zoneInput.value = current.zone ?? '';
        updateZoneModal(zones[current.zone] ?? {});
        zoneModal.classList.remove('hidden');
        zoneInput.focus();
        suspendCountdown();
    });

    window.addEventListener('load', function () {
        let currentData = window.localStorage.getItem('mosh:current');
        let journalData = window.localStorage.getItem('mosh:journal');
        let zonesData = window.localStorage.getItem('mosh:zones');

        current = currentData ? JSON.parse(currentData) : {
            encounter: null,
            encounterRate: 0.1,
            time: Math.floor((Date.now() + clockEpochOffset) / clockInterval) * clockInterval,
            turn: 1,
            zone: null,
        };

        zones = zonesData ? JSON.parse(zonesData) : {};
        journal = journalData ? JSON.parse(journalData) : [];
        journal.forEach(entry => displayJournalEntry(entry));

        updateClock();

        if (current.zone && current.zone in zones) {
            let environment = zones[current.zone];

            updateEnvironment(environment);
            updateZoneModal(environment);
            enableCountdownButtons();
            updateCountdown();
        }
    });
</script>

<!-- <template></template> -->

</body>
</html>