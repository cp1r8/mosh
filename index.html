<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Kode+Mono:wght@400..700&display=swap">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Emoji:wght@300..700&display=swap">
<link rel="stylesheet" href="./style/base.css">
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<style type="text/tailwindcss">
    button {
        @apply border-1 border-gray-900 cursor-pointer px-4 py-2 rounded-lg;
    }
    button:disabled {
        @apply cursor-default opacity-50;
    }
    button:hover {
        @apply bg-white border-white text-gray-700
    }
    img.crew-photo {
        @apply mix-blend-overlay;
    }
    input, textarea {
        @apply bg-gray-700 border-1 border-gray-900 px-2 py-1 rounded-lg;
    }
    select {
        @apply appearance-none border-1 border-gray-900 cursor-pointer pl-4 py-1 rounded-lg;
    }
    select:hover {
        @apply bg-white border-white text-gray-700
    }
</style>
<title>MOSH v1.01</title>
</head>
<body class="bg-cathode cyan flex flex-col gap-4 h-screen">

<header class="flex justify-between">
    <p id="clock">--/--/---- --:--</p>
    <p class="ruby" id="countdown-state">‚èπ STOPPED</p>
</header>

<!-- <nav></nav> -->

<main class="flex flex-col gap-4 h-full min-h-1/3 overflow-auto">

    <section class="flex flex-wrap gap-4 justify-center w-full">
        <div class="bg-cyan-600/25 rounded-xl">
            <div class="text-center">
                <div class="border-b border-gray-900 px-4 py-2 text-xl">
                    <h3><span id="turn">000</span></h3>
                </div>

                <div class="px-1 text-9xl w-100 whitespace-nowrap">
                    <p id="countdown-clock">--:--</p>
                </div>
            </div>
            <div class="flex gap-4 justify-center pb-2 text-2xl">
                <select class="cyan text-sm w-16" id="countdown-speed">
                    <option value="5.0">5.0&times;</option>
                    <option value="2.0">2.0&times;</option>
                    <option selected value="1.0">1.0&times;</option>
                    <option value="0.5">0.5&times;</option>
                    <option value="0.2">0.2&times;</option>
                </select>

                <button class="cyan w-16" disabled id="countdown-pause">
                    <i>‚èØÔ∏é</i>
                </button>

                <button class="cyan w-16" disabled id="countdown-skip">
                    <i>‚è≠Ô∏é</i>
                </button>

                <button class="cyan w-16" id="countdown-sound">
                    <i>üîï</i>
                </button>
            </div>
        </div>

        <div class="bg-cyan-600/25 rounded-xl" id="environment-panel">
            <div class="text-center">
                <h3 class="border-b border-gray-900 py-2 text-xl">ENVIRONMENT</h3>

                <div class="py-4 text-8xl w-48 whitespace-nowrap">
                    <i id="atmosphere-icon">üòë</i>
                </div>
            </div>
            <div class="flex gap-4 justify-evenly m-2 pt-1 text-2xl">
                <i id="gravity-icon">‚öì</i>
                <i id="radiation-icon">‚ãØ</i>
                <i id="light-icon">üîÖ</i>
            </div>
        </div>

        <div class="hidden bg-amber-600/25 rounded-xl" id="encounter-panel">
            <div class="text-center">
                <h3 class="border-b border-gray-900 py-2 text-xl">ENCOUNTER</h3>

                <div class="py-4 text-8xl w-48 whitespace-nowrap">
                    <i>‚úã</i>
                </div>
            </div>
            <div class="flex gap-4 justify-center pb-2 text-2xl">
                <button class="cyan w-16" id="encounter-dismiss">
                    <i>‚ùå</i>
                </button>
                <button class="cyan w-16" id="encounter-resolve">
                    <i>‚úîÔ∏é</i>
                </button>
            </div>
        </div>

        <div class="bg-cyan-600/25 rounded-xl" id="zone-panel">
            <div class="text-center">
                <h3 class="border-b border-gray-900 py-2 text-xl">ZONE</h3>

                <div class="py-4 text-8xl w-48 whitespace-nowrap">
                    <p id="zone-label">-?-</p>
                </div>
            </div>
            <div class="flex gap-4 justify-center pb-2 text-2xl">
                <button class="cyan w-16" disabled id="encounter-show">
                    <i>‚úã</i>
                </button>
                <button class="cyan w-16" id="zone-modal-show">
                    <i>‚Æï</i>
                </button>
            </div>
        </div>
    </section>

    <section class="hidden flex flex-wrap gap-4 justify-center w-full" id="crew-panels">
        <div class="bg-cyan-600/25 flex flex-col pb-4 rounded-xl text-center w-48">
            <h3 class="border-b border-gray-900 py-2">LCP MINERVA</h3>

            <div class="flex">
                <div class="relative w-32">
                    <img class="crew-photo w-32" src="./img/4D9N-5LOOQZ.png">
                </div>

                <ul class="flex flex-col gap-2 justify-between pr-2 pt-2 text-right w-16 whitespace-nowrap">
                    <li>36¬∞C</li>
                    <li>70 ‚ô•</li>
                    <li>.99O‚ÇÇ</li>
                    <li>118mm</li>
                </ul>
            </div>
        </div>

        <div class="amber bg-amber-600/25 flex flex-col pb-4 rounded-xl text-center w-48">
            <h3 class="border-b border-gray-900 py-2">DR ZAHIR</h3>

            <div class="flex">
                <div class="relative w-32">
                    <img class="crew-photo w-32" src="./img/CW01-241127.png">
                </div>

                <ul class="flex flex-col gap-2 justify-between pr-2 pt-2 text-right w-16 whitespace-nowrap">
                    <li>37¬∞C</li>
                    <li class="pulse ruby">147 ‚ô•</li>
                    <li>.97O‚ÇÇ</li>
                    <li>135mm</li>
                </ul>
            </div>
        </div>

        <div class="ruby bg-red-600/25 flex flex-col pb-4 rounded-xl text-center w-48">
            <h3 class="border-b border-gray-900 py-2">PVT LOUIS</h3>

            <div class="flex">
                <div class="overflow-hidden relative w-32">
                    <img class="crew-photo w-32" src="./img/HR01-241127.png">
                    <div class="absolute bg-red-900 block h-46 left-15 rotate-45 -top-7 w-2"></div>
                    <div class="absolute bg-red-900 block h-46 left-15 -rotate-45 -top-7 w-2"></div>
                </div>

                <ul class="flex flex-col gap-2 justify-between pr-2 pt-2 text-right w-16 whitespace-nowrap">
                    <li>---¬∞C</li>
                    <li>--- ‚ô•</li>
                    <li>---O‚ÇÇ</li>
                    <li>---mm</li>
                </ul>
            </div>
        </div>

        <div class="pulse-2s bg-cyan-600/25 flex flex-col pb-4 rounded-xl text-center w-48 xhidden">
            <h3 class="border-b border-gray-900 py-2">√âGLE-2</h3>

            <div class="flex">
                <div class="relative w-32">
                    <img class="crew-photo w-32" src="./img/LF01-241127.png">
                </div>

                <ul class="flex flex-col gap-2 justify-between pl-2 pt-2 text-left w-16 whitespace-nowrap">
                    <li class="amber">‚ñà‚ñà‚ñà‚ñç</li>
                    <li>‚ñà‚ñà‚ñç</li>
                    <li class="ruby">‚ñà‚ñà‚ñà‚ñà‚ñà</li>
                    <li>‚ñè</li>
                </ul>
            </div>
        </div>
    </section>

</main>

<section class="grow min-h-1/4 overflow-y-scroll">
    <div class="flex flex-col-reverse gap-1 whitespace-nowrap" id="journal-entries"></div>
</section>

<footer>
    <input class="w-full" id="comment-input" placeholder=">_">
</footer>

<div class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-700/50" id="zone-modal">
    <div class="bg-cyan-900 rounded-lg shadow-xl max-w-md w-full mx-auto overflow-hidden">
        <div class="flex gap-4 items-center p-4 border-b border-cyan-200">
            <h3 class="text-lg font-semibold">MOVE TO:</h3>
            <input class="w-14" id="zone-input" maxlength="3" required>
        </div>

        <div class="flex flex-col gap-4 p-6">
            <div class="flex items-center">
                <label class="mr-2" for="zone-light">ATMOSPHERE:</label>
                <select class="p-4 text-center w-full" id="zone-atmosphere">
                    <option value="breathable">Breathable</option>
                    <option value="corrosive">Corrosive</option>
                    <option value="extreme_cold">Extreme cold</option>
                    <option value="extreme_heat">Extreme heat</option>
                    <option value="hypoxic">Hypoxic</option>
                    <option value="toxic">Toxic</option>
                    <option value="vacuum">Vacuum</option>
                </select>
            </div>
            <div class="flex items-center">
                <label class="mr-2" for="zone-radiation">RADIATION:</label>
                <select class="p-4 text-center w-full" id="zone-radiation">
                    <option value="trace">Trace</option>
                    <option value="acute">Acute</option>
                    <option value="lethal">Lethal</option>
                </select>
            </div>
            <div class="flex items-center">
                <label class="mr-2" for="zone-light">LIGHT:</label>
                <select class="p-4 text-center w-full" id="zone-light">
                    <option value="bright">Bright</option>
                    <option value="dark">Dark</option>
                    <option value="dim">Dim</option>
                </select>

                <label class="ml-4 mr-2" for="zone-gravity">GRAVITY:</label>
                <select class="p-4 text-center" id="zone-gravity">
                    <option value="standard">1g</option>
                    <option value="zero_g">0g</option>
                </select>
            </div>
            <div class="flex items-center">
                <label class="mr-2" for="zone-encounter-rate">%ENC:</label>
                <input class="w-full" id="zone-encounter-rate" max="1.0" min="0.0" step="0.05" type="range" value="0.1">
            </div>
        </div>

        <div class="flex justify-end items-center p-4 border-t border-cyan-200 space-x-2">
            <button id="zone-modal-cancel">CANCEL</button>
            <button id="zone-modal-confirm">CONFIRM</button>
        </div>
    </div>
</div>

<script>
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    const atmosphereIcon = document.getElementById('atmosphere-icon');
    const commentInput = document.getElementById('comment-input');
    const countdownClock = document.getElementById('countdown-clock');
    const countdownPause = document.getElementById('countdown-pause');
    const countdownSkip = document.getElementById('countdown-skip');
    const countdownSound = document.getElementById('countdown-sound');
    const countdownSpeed = document.getElementById('countdown-speed');
    const countdownState = document.getElementById('countdown-state');
    const encounterPanel = document.getElementById('encounter-panel');
    const encounterShow = document.getElementById('encounter-show');
    const gravityIcon = document.getElementById('gravity-icon');
    const lightIcon = document.getElementById('light-icon');
    const journalEntries = document.getElementById('journal-entries');
    const radiationIcon = document.getElementById('radiation-icon');
    const zoneInput = document.getElementById('zone-input');
    const zoneLabel = document.getElementById('zone-label');
    const zoneModal = document.getElementById('zone-modal');
    const zonePanel = document.getElementById('zone-panel');

    const clockEpoch = 12_622_780_800_000; // 400 years (skip 3 leap days)
    const clockInterval = 600_000; // 10 minutes
    const countdownInterval = 1000; // milliseconds
    const countdownResetValue = 600_000; // 10 minutes
    const countdownWarningCritical = 10_000; // 10 seconds
    const countdownWarningThreshold = 60_000; // 60 seconds

    const icons = {
        atmosphere: {
            breathable: 'üôÇ',
            corrosive: 'ü´†',
            extreme_cold: 'ü•∂',
            extreme_heat: 'ü•µ',
            hypoxic: 'üò©', // üò´
            toxic: 'ü§Æ', // ‚ò†
            vacuum: 'üòµ', // üò±
        },
        gravity: {
            standard: '‚öì', // ü™®
            zero_g: 'ü™∂',
        },
        light: {
            bright: 'üîÜ', // üåûüåë‚ö™‚óè
            dark: 'üåï', // üî¶üëÄüëÅ‚ö´‚óã
            dim: 'üåô', // üåñ
        },
        radiation: {
            trace: '‚ãØ', // üü°‚ö™‚óè
            acute: '‚ò¢', // ‚ú≥Ô∏é‚ö†Ô∏é
            lethal: '‚ò†', // üî•‚ÄºÔ∏éüíÄ
        },
    };

    let clock = null;
    let countdownTimer = null;
    let countdownValue = countdownResetValue;
    let encounter = null;
    let environment = null;

    // TODO icon colours
    // TODO store journal entries and "replay" on reload
    // TODO depth gauge
    // TODO fatigue/exhaustion
    // TODO Google Sheets connection?

    function addJournalEntry(comment, style = null) {
        const entry = document.createElement('p');

        entry.innerText = [
            formatDate(clock.time),
            formatTime(clock.time),
            environment.zone,
            comment,
        ].join(' ');

        if (style) {
            entry.setAttribute('class', style);
        }

        journalEntries.appendChild(entry);
    }

    function advanceClock() {
        let comment = commentInput.value.trim();

        if (! comment || comment.startsWith('/')) {
            comment = encounter ? 'ENC' : 'NTR';
        } else {
            commentInput.value = '';
        }

        addJournalEntry(comment, encounter ? 'amber' : null);

        clock.time += clockInterval;
        clock.turn++;
        window.localStorage.setItem('mosh:clock', JSON.stringify(clock));
        updateClock();

        countdownValue = countdownResetValue;
        encounter = null;
        updateCountdown();
    }

    function enableCountdownButtons() {
        countdownPause.removeAttribute('disabled');
        countdownSkip.removeAttribute('disabled');
        encounterShow.removeAttribute('disabled');
    }

    function execute(command) {
        if (command === 'clear') {
            window.localStorage.clear();
        }
    }

    function expireCountdown() {
        suspendCountdown();

        if (Math.random() < environment.encounterRate) {
            encounter = {roll: Math.floor(Math.random() * 10)};
            commentInput.value = 'Encounter ' + encounter.roll.toLocaleString().padStart(2, '0');
            playTone(660, 1.0, 'sine');
            updateEncounter();
        } else {
            advanceClock();
            resumeCountdown();
        }
    }

    function formatDate(value) {
        return new Intl.DateTimeFormat(undefined, {
            dateStyle: 'short',
            timeZone: 'UTC'
        }).format(value);
    }

    function formatTime(value) {
        return new Intl.DateTimeFormat(undefined, {
            timeStyle: 'short',
            timeZone: 'UTC'
        }).format(value);
    }

    function playTone(frequency, duration = 1.0, waveform = 'sine') {
        if (audioContext?.state !== 'running') {
            return;
        }

        const gainNode = audioContext.createGain();

        gainNode.gain.value = 0.10; // 10%
        gainNode.connect(audioContext.destination);

        const oscillator = audioContext.createOscillator();

        oscillator.frequency.value = frequency; // Hz
        oscillator.type = waveform;
        oscillator.connect(gainNode);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + duration); // seconds
    }

    function resumeCountdown() {
        if (countdownTimer) {
            return;
        }

        // countdownPause.innerHTML = '<i>‚è∏</i>';
        countdownState.innerText = '‚èµ RUNNING';
        countdownState.setAttribute('class', 'green');
        updateCountdown();

        countdownTimer = window.setInterval(function () {
            countdownValue -= countdownInterval * countdownSpeed.value;

            if (countdownValue <= 0) {
                countdownValue = 0;
                expireCountdown();
            }

            updateCountdown();
        }, countdownInterval);
    }

    function suspendCountdown() {
        if (! countdownTimer) {
            return;
        }

        // countdownPause.innerHTML = '<i>‚èµ</i>';
        countdownState.innerText = '‚è∏ PAUSED';
        countdownState.setAttribute('class', 'amber blink-1s');
        window.clearInterval(countdownTimer);
        countdownTimer = null;
    }

    function updateClock() {
        document.getElementById('clock').innerText = [
            formatDate(clock.time),
            formatTime(clock.time),
        ].join(' ');

        document.getElementById('turn').innerText = clock.turn.toLocaleString().padStart(3, '0');
    }

    function updateCountdown() {
        if (countdownValue <= 0) {
            countdownClock.setAttribute('class', 'ruby');
            playTone(55, 1.0, 'square');
        } else if (countdownValue <= countdownWarningCritical) {
            countdownClock.setAttribute('class', 'amber blink');
            playTone(220, 0.10, 'sawtooth');
        } else if (countdownValue <= countdownWarningThreshold) {
            countdownClock.setAttribute('class', 'amber');
            playTone(440, 0.05, 'triangle');
        } else {
            countdownClock.removeAttribute('class');
        }

        let minutes = Math.floor(countdownValue / 60_000);
        let seconds = Math.floor((countdownValue % 60_000) / 1000);

        countdownClock.innerText = [
            minutes.toLocaleString().padStart(2, '0'),
            seconds.toLocaleString().padStart(2, '0'),
        ].join(':');
    }

    function updateEncounter() {
        countdownPause.setAttribute('disabled', 'disabled');
        countdownSkip.setAttribute('disabled', 'disabled');
        encounterPanel.classList.remove('hidden');
        zonePanel.classList.add('hidden');
    }

    function updateEnvironment() {
        atmosphereIcon.innerText = icons.atmosphere[environment.atmosphere];
        gravityIcon.innerText = icons.gravity[environment.gravity];
        lightIcon.innerText = icons.light[environment.light];
        radiationIcon.innerText = icons.radiation[environment.radiation];
        zoneLabel.innerText = environment.zone;

        if (environment.light === 'dark') {
            lightIcon.setAttribute('class', 'ruby');
        } else if (environment.light === 'dim') {
            lightIcon.setAttribute('class', 'amber');
        } else {
            lightIcon.removeAttribute('class');
        }
    }

    commentInput,addEventListener('keyup', function (e) {
        if (e.which === 13) { // ENTER
            let comment = commentInput.value.trim();

            if (! comment) {
                return;
            }
            
            if (comment.startsWith('/')) {
                execute(comment.substr(1).toLocaleLowerCase());
            } else {
                addJournalEntry(comment, encounter ? 'amber' : null);
            }

            commentInput.value = '';
        } else if (e.which === 27) { // ESC
            commentInput.value = '';
        }
    });

    countdownPause.addEventListener('click', function () {
        if (countdownTimer) {
            suspendCountdown();
        } else {
            resumeCountdown();
        }
    });

    countdownSkip.addEventListener('click', expireCountdown);

    countdownSound.addEventListener('click', function () {
        if (audioContext?.state === 'running') {
            countdownSound.innerHTML = '<i>üîï</i>';
            audioContext.suspend();
        } else if (audioContext?.state === 'suspended') {
            countdownSound.innerHTML = '<i>üîî</i>';
            audioContext.resume();
        }
    });

    encounterShow.addEventListener('click', function () {
        encounter = {};
        commentInput.value = 'Encounter';
        suspendCountdown();
        updateEncounter();
    });

    document.getElementById('encounter-dismiss').addEventListener('click', function () {
        encounter = null;
        commentInput.value = '';
        encounterPanel.classList.add('hidden');
        zonePanel.classList.remove('hidden');
        enableCountdownButtons();
        resumeCountdown();
    });

    document.getElementById('encounter-resolve').addEventListener('click', function () {
        encounterPanel.classList.add('hidden');
        zonePanel.classList.remove('hidden');
        enableCountdownButtons();
        advanceClock();
        resumeCountdown();
    });

    document.getElementById('zone-modal-cancel').addEventListener('click', function () {
        zoneModal.classList.add('hidden');
    });

    document.getElementById('zone-modal-confirm').addEventListener('click', function () {
        const zone = zoneInput.value.trim().toUpperCase();

        if (! zone) {
            zoneInput.focus();
            return;
        }

        if (environment === null) {
            enableCountdownButtons();
        } else if (environment?.zone !== zone) {
            advanceClock();
        }
        
        environment = {
            encounterRate: document.getElementById('zone-encounter-rate').value,
            atmosphere: document.getElementById('zone-atmosphere').value,
            radiation: document.getElementById('zone-radiation').value,
            gravity: document.getElementById('zone-gravity').value,
            light: document.getElementById('zone-light').value,
            zone: zone,
        };

        window.localStorage.setItem('mosh:environment', JSON.stringify(environment));
        zoneModal.classList.add('hidden');
        updateEnvironment();
        resumeCountdown();
    });

    document.getElementById('zone-modal-show').addEventListener('click', function () {
        zoneModal.classList.remove('hidden');
        zoneInput.focus();
        suspendCountdown();
    });

    window.addEventListener('load', function () {
        let clockData = window.localStorage.getItem('mosh:clock');

        clock = clockData ? JSON.parse(clockData) : {
            time: Math.floor((Date.now() + clockEpoch) / clockInterval) * clockInterval,
            turn: 0,
        };

        updateClock();

        let environmentData = window.localStorage.getItem('mosh:environment');

        if (environmentData) {
            environment = JSON.parse(environmentData);
            zoneInput.value = environment.zone ?? '';
            enableCountdownButtons();
            updateEnvironment();
            updateCountdown();
        }
    });
</script>
<!-- <template></template> -->
</body>
</html>